<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Transporte Escolar</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center}
        .header h1{font-size:2.5em;margin-bottom:10px}
        .header p{font-size:1.1em;opacity:.9}
        .content{padding:30px}
        .section{margin-bottom:30px}
        .section-title{font-size:1.5em;color:#333;margin-bottom:20px;border-bottom:2px solid #667eea;padding-bottom:10px}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;color:#333;font-weight:500}
        input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:5px;font-size:1em;transition:border-color .3s}
        input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 5px rgba(102,126,234,.3)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media (max-width:768px){.form-row{grid-template-columns:1fr}}
        .button-group{display:flex;gap:10px;margin-top:20px}
        button{padding:12px 24px;border:none;border-radius:5px;font-size:1em;cursor:pointer;transition:all .3s;font-weight:600}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;flex:1}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,.4)}
        .btn-secondary{background:#f0f0f0;color:#333;flex:1}
        .btn-secondary:hover{background:#e0e0e0}
        .btn-danger{background:#ff6b6b;color:white;padding:8px 16px;font-size:.9em}
        .btn-danger:hover{background:#ff5252}
        .rota-card{background:#f9f9f9;border:1px solid #ddd;border-radius:5px;padding:15px;margin-bottom:15px;position:relative}
        .rota-card.invalid{background:#ffe0e0;border-color:#ff6b6b}
        .rota-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .rota-card-title{font-weight:600;color:#333}
        .rota-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        .results-container{display:none;animation:slideIn .3s ease-in-out}
        .results-container.show{display:block}
        @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .resultado-rota{background:#f0f7ff;border-left:4px solid #667eea;padding:20px;margin-bottom:20px;border-radius:5px}
        .resultado-rota-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .resultado-rota-title{font-size:1.2em;font-weight:600;color:#333}
        .resultado-rota-id{background:#667eea;color:white;padding:4px 12px;border-radius:20px;font-size:.85em}
        .resultado-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px}
        @media (max-width:768px){.resultado-grid{grid-template-columns:1fr}}
        .resultado-item{background:white;padding:15px;border-radius:5px;border:1px solid #ddd}
        .resultado-label{font-size:.9em;color:#666;margin-bottom:5px}
        .resultado-valor{font-size:1.3em;font-weight:600;color:#667eea}
        .resultado-valor.negativo{color:#ff6b6b}
        .sumario{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:5px;margin-top:20px}
        .sumario-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px}
        .sumario-item{text-align:center}
        .sumario-label{font-size:.9em;opacity:.9;margin-bottom:5px}
        .sumario-valor{font-size:1.5em;font-weight:600}
        .invariantes{margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,.3)}
        .invariante-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:.95em}
        .status-ok{background:#4caf50;color:white;padding:4px 12px;border-radius:20px;font-size:.85em;font-weight:600}
        .status-falha{background:#ff6b6b;color:white;padding:4px 12px;border-radius:20px;font-size:.85em;font-weight:600}
        .loading{display:none;text-align:center;padding:20px}
        .loading.show{display:block}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 10px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .error-message{background:#ffe0e0;color:#d32f2f;padding:15px;border-radius:5px;margin-bottom:20px;border-left:4px solid #d32f2f;display:none}
        .error-message.show{display:block}
        .success-message{background:#e8f5e9;color:#2e7d32;padding:15px;border-radius:5px;margin-bottom:20px;border-left:4px solid #2e7d32;display:none}
        .success-message.show{display:block}
        .footer{background:#f5f5f5;padding:20px;text-align:center;color:#666;font-size:.9em;border-top:1px solid #ddd}
        .penalidade-badge{background:#fff3cd;color:#856404;padding:4px 12px;border-radius:20px;font-size:.85em;display:inline-block;margin-top:10px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Transporte Escolar</h1>
            <p>Gerenciamento de Rotas, Custos e Eficiência</p>
        </div>
        <div class="content">
            <div class="section">
                <h2 class="section-title">Configuração de Rotas</h2>
                <div class="form-group">
                    <label for="taxa-penalidade">Taxa de Penalidade por Minuto de Atraso (R$)</label>
                    <input type="number" id="taxa-penalidade" min="0" step="0.01" value="0.50" placeholder="0.50">
                </div>
                <div id="rotas-container"></div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="adicionarRota()">+ Adicionar Rota</button>
                    <button class="btn-primary" onclick="processarRotas()">Calcular Custos</button>
                </div>
            </div>
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processando dados...</p>
            </div>
            <div id="results-container" class="results-container section">
                <h2 class="section-title">Resultados do Processamento</h2>
                <div id="resultados-rotas"></div>
                <div id="sumario"></div>
            </div>
        </div>
        <footer class="footer">
            Desenvolvido por: <strong>Vinicius Policarpo Macedo e Misael Sardá</strong>
        </footer>
    </div>

    <script>
        const rotasPadrao = [
            {id:"rota-001",nome:"Rota Centro",km_rodados:50.5,alunos:10,consumo_medio_litro_por_km:0.1,preco_combustivel_por_litro:5.50,atraso_minutos:15},
            {id:"rota-002",nome:"Rota Bairro Sul",km_rodados:30.0,alunos:8,consumo_medio_litro_por_km:0.12,preco_combustivel_por_litro:5.50,atraso_minutos:0},
            {id:"rota-003",nome:"Rota Zona Rural",km_rodados:75.2,alunos:12,consumo_medio_litro_por_km:0.09,preco_combustivel_por_litro:5.50,atraso_minutos:5}
        ];
        let rotas=[...rotasPadrao];
        function inicializar(){renderizarRotas();}
        function renderizarRotas(){
            const c=document.getElementById('rotas-container');c.innerHTML='';
            rotas.forEach((r,i)=>{c.innerHTML+=`
                <div class="rota-card" data-index="${i}">
                    <div class="rota-card-header">
                        <div class="rota-card-title">${r.nome}</div>
                        <button class="btn-danger" onclick="removerRota(${i})">Remover</button>
                    </div>
                    <div class="rota-grid">
                        <div class="form-group"><label>ID da Rota</label><input type="text" value="${r.id}" onchange="atualizarRota(${i},'id',this.value)"></div>
                        <div class="form-group"><label>Nome da Rota</label><input type="text" value="${r.nome}" onchange="atualizarRota(${i},'nome',this.value)"></div>
                        <div class="form-group"><label>Km Rodados</label><input type="number" value="${r.km_rodados}" onchange="atualizarRota(${i},'km_rodados',parseFloat(this.value.replace(',','.')))"></div>
                        <div class="form-group"><label>Número de Alunos</label><input type="number" value="${r.alunos}" onchange="atualizarRota(${i},'alunos',parseInt(this.value))"></div>
                        <div class="form-group"><label>Consumo (L/km)</label><input type="number" value="${r.consumo_medio_litro_por_km}" onchange="atualizarRota(${i},'consumo_medio_litro_por_km',parseFloat(this.value.replace(',','.')))"></div>
                        <div class="form-group"><label>Preço Combustível (R$/L)</label><input type="number" value="${r.preco_combustivel_por_litro}" onchange="atualizarRota(${i},'preco_combustivel_por_litro',parseFloat(this.value.replace(',','.')))"></div>
                        <div class="form-group"><label>Atraso (minutos)</label><input type="number" value="${r.atraso_minutos}" onchange="atualizarRota(${i},'atraso_minutos',parseInt(this.value))"></div>
                    </div>
                </div>`});
        }
        function adicionarRota(){rotas.push({id:`rota-${String(rotas.length+1).padStart(3,'0')}`,nome:`Nova Rota ${rotas.length+1}`,km_rodados:0,alunos:0,consumo_medio_litro_por_km:0.1,preco_combustivel_por_litro:5.50,atraso_minutos:0});renderizarRotas();}
        function removerRota(i){rotas.splice(i,1);renderizarRotas();}
        function atualizarRota(i,c,v){rotas[i][c]=typeof v==='string'&&!isNaN(parseFloat(v.replace(',','.')))?parseFloat(v.replace(',','.')):v;}
        async function processarRotas(){
            const t=parseFloat(document.getElementById('taxa-penalidade').value)||0.50;
            document.getElementById('error-message').classList.remove('show');
            document.getElementById('success-message').classList.remove('show');
            if(rotas.length===0){mostrarErro('Adicione pelo menos uma rota antes de processar.');return;}
            document.getElementById('loading').classList.add('show');
            try{
                const r=await fetch('api.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rotas:rotas,taxa_penalidade_por_minuto:t})});
                const d=await r.json();
                if(!r.ok||!d.sucesso)throw new Error(d.erro||'Erro ao processar rotas');
                exibirResultados(d.resultados,d.sumario);
                mostrarSucesso('Rotas processadas com sucesso!');
            }catch(e){mostrarErro(`Erro: ${e.message}`);}
            finally{document.getElementById('loading').classList.remove('show');}
        }
        function exibirResultados(r,s){
            const rc=document.getElementById('resultados-rotas');
            const sc=document.getElementById('sumario');
            rc.innerHTML='';
            r.forEach(x=>{
                const p=x.penalidade_aplicada>0?`<div class="penalidade-badge">Penalidade: R$ ${x.penalidade_aplicada.toFixed(2)}</div>`:'';
                rc.innerHTML+=`
                    <div class="resultado-rota">
                        <div class="resultado-rota-header">
                            <div class="resultado-rota-title">${x.nome}</div>
                            <div class="resultado-rota-id">${x.id}</div>
                        </div>
                        <div class="resultado-grid">
                            <div class="resultado-item"><div class="resultado-label">Custo Total da Rota</div><div class="resultado-valor">R$ ${x.custo_total_rota.toFixed(2)}</div></div>
                            <div class="resultado-item"><div class="resultado-label">Custo por Aluno</div><div class="resultado-valor">R$ ${x.custo_por_aluno_rota.toFixed(2)}</div></div>
                            <div class="resultado-item"><div class="resultado-label">Eficiência (km/aluno)</div><div class="resultado-valor">${x.eficiencia_km_por_aluno.toFixed(2)}</div></div>
                        </div>${p}
                    </div>`;
            });
            const scg=s.invariante_custo_global?'OK':'FALHA';
            const skr=s.invariante_km_rodados?'OK':'FALHA';
            sc.innerHTML=`
                <div class="sumario">
                    <div class="sumario-grid">
                        <div class="sumario-item"><div class="sumario-label">Custo Global Total</div><div class="sumario-valor">R$ ${s.custo_global_total.toFixed(2)}</div></div>
                        <div class="sumario-item"><div class="sumario-label">Total Rateado</div><div class="sumario-valor">R$ ${s.total_rateado.toFixed(2)}</div></div>
                    </div>
                    <div class="invariantes">
                        <div class="invariante-item"><span>Invariante: Custo Global vs Total Rateado</span><span class="status-${scg.toLowerCase()}">${scg}</span></div>
                        <div class="invariante-item"><span>Invariante: Km Rodados > 0</span><span class="status-${skr.toLowerCase()}">${skr}</span></div>
                    </div>
                </div>`;
            document.getElementById('results-container').classList.add('show');
        }
        function mostrarErro(m){const e=document.getElementById('error-message');e.textContent=m;e.classList.add('show');}
        function mostrarSucesso(m){const s=document.getElementById('success-message');s.textContent=m;s.classList.add('show');setTimeout(()=>{s.classList.remove('show');},3000);}
        window.addEventListener('DOMContentLoaded',inicializar);
    </script>
</body>
</html>
